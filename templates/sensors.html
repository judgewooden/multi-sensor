<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id='Description'>Dashboard</title>

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <!-- jQWidgets CSS -->
    <script src="http://code.jquery.com/jquery-1.7.2.min.js"></script>
    <!-- # PROBABLE NO NEEDED
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tipsy/1.0.2/jquery.tipsy.js"></script>
    -->
    <script src="https://code.jquery.com/jquery-1.11.0.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='sensorGraphStyle.css') }}">
</head>
<script>
// This activates the bootstrap tooltips section
$(function () {
  $('[data-toggle="tooltip"]').tooltip();
})

$(function () {
  $('[data-click="jph"]').click(function (event) {
    var code=$(this).attr("id").substring(0,2); 
    var xmlhttp;
    xmlhttp=new XMLHttpRequest();
    xmlhttp.onreadystatechange=function() {
        if (xmlhttp.readyState==4 && xmlhttp.status==200) {
            $("#CC").html(xmlhttp.responseText);
        }
    }
    x="http://mad:5000/toggle/"+code;
    try {
        xmlhttp.open("GET",x,true); 
        xmlhttp.send();
    } catch(err) {
        alert(err);
        //Handle errors here
    }
  })
})

//
// Global Variables
//
var RefreshRate=1000;           // Update Frequency for client browser (for poling version)

var STATUS = {                  // enum the status per sensor
  INFO : {value: 0},
  IWARNING : {value: 1}, 
  DWARNING : {value: 2},
  HEADING : {value: 3}
};

// Load the Data arrays for working on the data
var mySensors = {{ sensors|tojson }};
for (var key in mySensors) {
    mySensors[key].LastITimestamp=0;
    mySensors[key].LastDTimestamp=0;
    mySensors[key].LastStatus=STATUS.INFO;
}
// console.log(mySensors);

var updateTimes = function() {

    //
    // Check here if there is any stale date
    //
    for ( i=mySensors.length;i--; ) {
        s=mySensors[i];
        if (s.Sensor.Type=="ControlProgram")       // This sensor shows messages to users
            continue;

        // Rethink this for PROXY
        if (s.Active) {
            n=parseInt((Date.now()-RefreshRate)/1000);
            if ((n - s.SensorInterval) > s.LastDTimestamp) {
                newStatus=STATUS.DWARNING;
            } else {
                // only do this for sensors that is not a proxy
                if ((n-s.KeepAliveInterval) > s.LastITimestamp) {
                    newStatus=STATUS.IWARNING;
                } else {
                    newStatus=STATUS.HEADING;
                }
            }
        } else {
            newStatus=STATUS.INFO;
            if (s.Sensor.Type == "Proxy") {
                p=findSensor(s.Sensor.Codifier);
                if (p==null) {
                    console.log("Strange? Proxy sensors not found ", s.Sensor.Codifier );
                    continue;
                }
                if (p.LastStatus==STATUS.IWARNING) {
                    newStatus=STATUS.IWARNING;
                } else {
                    if (p.LastStatus!=STATUS.INFO) {
                        n=parseInt((Date.now()-RefreshRate)/1000);
                        if ((n - p.SensorInterval) > s.LastDTimestamp) {
                            newStatus=STATUS.DWARNING;
                        } else {
                            newStatus=STATUS.HEADING;
                        }
                    }
                }
            }
        }

        if ( newStatus != s.LastStatus) {
            switch(newStatus) {
                case STATUS.HEADING:
                    $("#"+s.Codifier+"c").addClass("panel-heading");
                    $("#"+s.Codifier+"c").removeClass("panel-warning");
                    $("#"+s.Codifier+"c").removeClass("panel-info");
                    break;
                case STATUS.DWARNING:
                case STATUS.IWARNING:
                    $("#"+s.Codifier+"c").removeClass("panel-heading");
                    $("#"+s.Codifier+"c").addClass("panel-warning");
                    $("#"+s.Codifier+"c").removeClass("panel-info");
                    break;
                case STATUS.INFO:
                    $("#"+s.Codifier+"c").removeClass("panel-heading");
                    $("#"+s.Codifier+"c").removeClass("panel-warning");
                    $("#"+s.Codifier+"c").addClass("panel-info");
                    break;
            }
            s.LastStatus=newStatus;
        }
        if (s.LastDTimestamp != 0) {
            // d = new Date(s.LastDTimestamp * 1000);
            d = parseInt(s.LastDTimestamp * 1000);
            $("#"+s.Codifier+"t").html( time_ago(d) );
        }
    }
}

var updateValues = function() {
    // Create a promise to get new data
    jQuery.getJSON("/sensor/").done(function(response) {
        if ( response.length > 0) {
            for (var key in response) {
                s=findSensor(response[key].Codifier);
                if (s==null) {
                    console.log("a new sensor:", reponse[key].Codifier)
                    // DOUWE: (Test this???) window.location.reload(true);
                    continue
                }

                // check if the Control system changed the state of a sensor
                t=parseInt(response[key].ITimestamp);
                if (t>s.LastITimestamp) { 
                    s.Active = toBoolean(response[key].isActive);
                    s.LastITimestamp=t;
                    m= new Date(t*1000).toISOString().slice(0,19).replace('T', ' ')
                    $("#"+s.Codifier+'t').attr('data-original-title', 'Last Ping Received: ' + m)
                        .tooltip('fixTitle');
                }

                // check if the Sensor provided a new value
                t=parseInt(response[key].DTimestamp);
                if (t>s.LastDTimestamp) {
                    $("#"+s.Codifier).html( afronden(parseFloat(response[key].Value).toFixed(1)) + "" + s.Symbol);
                    s.LastDTimestamp=t;
                }
            }
        }
    });
};

// Loop and update the screen all the time
var IamInProgress = false;
var ttimer = setInterval(function () {
    if (IamInProgress)
        return;
    IamInProgress=true;
    updateValues();
    updateTimes();
    IamInProgress=false;
}, RefreshRate);

function time_ago(time) { // add a parameter to add red items that are old than X time
    switch (typeof time) {
        case 'number': break;
        case 'string': time = +new Date(time); break;
        case 'object': if (time.constructor === Date) time = time.getTime(); break;
        default: time = +new Date();
    }
    var time_formats = [
        [60, 'seconds', 1], // 60
        [120, '1 minute ago', '1 minute from now'], // 60*2
        [3600, 'minutes', 60], // 60*60, 60
        [7200, '1 hour ago', '1 hour from now'], // 60*60*2
        [86400, 'hours', 3600], // 60*60*24, 60*60
        [172800, 'Yesterday', 'Tomorrow'], // 60*60*24*2
        [604800, 'days', 86400], // 60*60*24*7, 60*60*24
        [1209600, 'Last week', 'Next week'], // 60*60*24*7*4*2
        [2419200, 'weeks', 604800], // 60*60*24*7*4, 60*60*24*7
        [4838400, 'Last month', 'Next month'], // 60*60*24*7*4*2
        [29030400, 'months', 2419200], // 60*60*24*7*4*12, 60*60*24*7*4
        [58060800, 'Last year', 'Next year'], // 60*60*24*7*4*12*2
        [2903040000, 'years', 29030400], // 60*60*24*7*4*12*100, 60*60*24*7*4*12
        [5806080000, 'Last century', 'Next century'], // 60*60*24*7*4*12*100*2
        [58060800000, 'centuries', 2903040000] // 60*60*24*7*4*12*100*20, 60*60*24*7*4*12*100
    ];
    var seconds = (+new Date() - time) / 1000,
        token = 'ago', list_choice = 1;

    if (seconds < 1 && seconds > 0) {
        return 'Just now'
    }
    if (seconds < 0) {
        seconds = Math.abs(seconds);
        token = 'from now';
        list_choice = 2;
    }
    var i = 0, format;
    while (format = time_formats[i++])
        if (seconds < format[0]) {
            if (typeof format[2] == 'string')
                return format[list_choice];
            else
                return Math.floor(seconds / format[2]) + ' ' + format[1] + ' ' + token;
        }
    return time;
};

var afronden = function( inputValue ) {
   if (inputValue > 100)
           return Math.round(inputValue * 1) / 1;
   else {
       if (inputValue > 10)
           return Math.round(inputValue * 10) / 10;
       else {
           if (inputValue > 1)
               return Math.round(inputValue * 100) / 100;
           else
               return Math.round(inputValue * 1000) / 1000;
       }
    }
};

var toBoolean = function(value) {
    var strValue = String(value).toLowerCase();
    strValue = ((!isNaN(strValue) && strValue !== '0') &&
        strValue !== '' &&
        strValue !== 'null' &&
        strValue !== 'undefined') ? '1' : strValue;
    return strValue === 'true' || strValue === '1' ? true : false
};

function findSensor (val) { 
  for (var ai, i = mySensors.length; i--;)
    if ((ai = mySensors[i]) && ai["Codifier"] == val)
      return ai;
  return null;
}


</script>
<body style="background:white;">
{% include "menubar.html" %}
<div style="position:relative;width:100%;height:7px"></div>
        <div class="container-fluid" style="width:100%">

        <div class="row">
{% for sensor in sensors %}

            <div class="col-md-2">
            <div class="panel panel-primary dash-box">
                <div class="
                    {% if sensor.Active %}
                        panel-heading
                    {% else %}
                        panel-info
                    {% endif %}
                    dash-title" data-click="jph" data-toggle="tooltip" data-placement="bottom" 
                    title="({{ sensor.Codifier }}) {{ sensor.Name }}" id="{{ sensor.Codifier }}c">
                    {{ sensor.ShortName }}</div>
                <div class="panel-body dash-value" id="{{ sensor.Codifier }}"></div>
                <div class="panel-footer dash-time" id="{{ sensor.Codifier }}t" data-toggle="tooltip"
                    data-placement="top" title="No start/stop information available"></div>
            </div>
            </div>
{% endfor %}

        </div>
        </div>
    </div>
</div>
</body>
</html>

